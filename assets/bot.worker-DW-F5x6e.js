(function(){"use strict";const p={ROW_SIZE:9,BOT_SEARCH_LIMIT:3e3,SCORE:{VERTICAL:120,SAME_VALUE:15,CHAIN_REACTION:40,POSITION_PENALTY:.005}},a=p.ROW_SIZE,h=(e,c,o)=>{const n=e[c];return n?n.next===o||n.prev===o:!1},I=(e,c,o)=>{const n=c%a,s=o%a;if(n!==s)return!1;const t=Math.min(c,o),r=Math.max(c,o);for(let i=t+a;i<r;i+=a){const u=e[i];if(u&&u.status!=="crossed")return!1}return!0},M=(e,c,o)=>{const n=e[c],s=e[o];return!n||!s||n.status==="crossed"||s.status==="crossed"||n.value!==s.value&&n.value+s.value!==10?!1:h(e,c,o)||I(e,c,o)},x=(e,c)=>{const o=[],n=e[c];if(!n)return[];n.prev!==null&&n.prev!==void 0&&o.push(n.prev),n.next!==null&&n.next!==void 0&&o.push(n.next);const s=e.length;for(let t=c+a;t<s;t+=a){const r=e[t];if(r&&r.status!=="crossed"){o.push(t);break}}for(let t=c-a;t>=0;t-=a){const r=e[t];if(r&&r.status!=="crossed"){o.push(t);break}}return o},C=(e,c,o)=>{const n=e[c],s=e[o];if(!n||!s)return-1;if(n.next!==null&&n.next!==void 0){const i=n.next,u=e[i];if(u&&u.status!=="crossed"&&u.next===o)return i}const t=c%a,r=o%a;if(t===r){const i=Math.min(c,o),u=Math.max(c,o);let v=0,d=-1;for(let f=i+a;f<u;f+=a){const l=e[f];l&&l.status!=="crossed"&&(v++,d=f)}if(v===1)return d}return-1},E=e=>{const c=e.length,o=Math.min(c,2e3);for(let n=0;n<o;n++){const s=e[n];if(!s||s.status==="crossed")continue;const t=Math.min(c,n+200);for(let r=n+1;r<t;r++){const i=e[r];if(!(!i||i.status==="crossed")&&(s.value===i.value||s.value+i.value===10)){const u=C(e,n,r);if(u!==-1)return u}}}return null},g=(e,c,o)=>{const n=e[c],s=e[o];if(!n||!s)return 0;let t=10;if(c%a===o%a&&(t+=p.SCORE.VERTICAL),n.value===s.value&&(t+=p.SCORE.SAME_VALUE),t-=c*p.SCORE.POSITION_PENALTY,h(e,c,o)){const i=Math.min(c,o),u=Math.max(c,o),v=e[i].prev,d=e[u].next;if(v!=null&&d!==null&&d!==void 0){const f=e[v],l=e[d];f&&l&&f.status!=="crossed"&&l.status!=="crossed"&&(f.value===l.value||f.value+l.value===10)&&(t+=p.SCORE.CHAIN_REACTION)}}return t},A=(e,c,o)=>{const n=[],s=e[c],t=e[o];if(!s||!t)return[];if(s.status="crossed",t.status="crossed",s.prev!==null&&s.prev!==void 0){const r=e[s.prev];r&&(n.push({index:s.prev,field:"next",oldValue:r.next}),r.next=s.next)}if(s.next!==null&&s.next!==void 0){const r=e[s.next];r&&(n.push({index:s.next,field:"prev",oldValue:r.prev}),r.prev=s.prev)}if(t.prev!==null&&t.prev!==void 0){const r=e[t.prev];r&&(n.push({index:t.prev,field:"next",oldValue:r.next}),r.next=t.next)}if(t.next!==null&&t.next!==void 0){const r=e[t.next];r&&(n.push({index:t.next,field:"prev",oldValue:r.prev}),r.prev=t.prev)}return n},O=(e,c,o,n)=>{e[c]&&(e[c].status="active"),e[o]&&(e[o].status="active");for(let s=n.length-1;s>=0;s--){const t=n[s];if(!t)continue;const r=e[t.index];r&&(r[t.field]=t.oldValue)}},R=(e,c=-1)=>{const o=[],n=e.length,s=n>4e3?p.BOT_SEARCH_LIMIT:n;for(let t=0;t<s;t++){const r=e[t];if(!r||r.status==="crossed")continue;const i=x(e,t);for(const u of i)if(u>t&&M(e,t,u)){const v=g(e,t,u);o.push({idx1:t,idx2:u,score:v})}}return o.sort((t,r)=>r.score-t.score),c>0&&o.length>c?o.slice(0,c):o},m=(e,c)=>{const o=R(e,8);if(o.length===0)return{score:0,move:null};let n=-1/0,s=null;for(const t of o){let r=t.score;if(c>0){const i=A(e,t.idx1,t.idx2),u=m(e,c-1);r+=u.score*.6,O(e,t.idx1,t.idx2,i)}r>n&&(n=r,s=[t.idx1,t.idx2])}return{score:n,move:s}};self.onmessage=e=>{const{type:c,cells:o,checkHammer:n}=e.data;if(c==="find"){const s=m(o,1);if(s.move)self.postMessage({type:"moveFound",move:s.move});else if(n){const t=E(o);self.postMessage({type:"moveFound",move:null,hammerTarget:t})}else self.postMessage({type:"moveFound",move:null})}}})();
