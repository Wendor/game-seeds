(function(){"use strict";const l={ROW_SIZE:9,BOT_SEARCH_LIMIT:3e3,SCORE:{VERTICAL:120,SAME_VALUE:15,CHAIN_REACTION:40,POSITION_PENALTY:.005}},f=l.ROW_SIZE,m=(e,c,o)=>{const n=e[c];return n?n.next===o||n.prev===o:!1},M=(e,c,o)=>{const n=c%f,s=o%f;if(n!==s)return!1;const t=Math.min(c,o),r=Math.max(c,o);for(let i=t+f;i<r;i+=f){const u=e[i];if(u&&u.status!=="crossed")return!1}return!0},E=(e,c,o)=>{const n=e[c],s=e[o];return!n||!s||n.status==="crossed"||s.status==="crossed"||n.value!==s.value&&n.value+s.value!==10?!1:m(e,c,o)||M(e,c,o)},x=(e,c)=>{const o=[],n=e[c];if(!n)return[];n.prev!==null&&n.prev!==void 0&&o.push(n.prev),n.next!==null&&n.next!==void 0&&o.push(n.next);const s=e.length;for(let t=c+f;t<s;t+=f){const r=e[t];if(r&&r.status!=="crossed"){o.push(t);break}}for(let t=c-f;t>=0;t-=f){const r=e[t];if(r&&r.status!=="crossed"){o.push(t);break}}return o},d=l.ROW_SIZE,C=(e,c,o)=>{const n=e[c],s=e[o];if(!n||!s)return-1;if(n.next!==null&&n.next!==void 0){const i=n.next,u=e[i];if(u&&u.status!=="crossed"&&u.next===o)return i}const t=c%d,r=o%d;if(t===r){const i=Math.min(c,o),u=Math.max(c,o);let v=0,h=-1;for(let a=i+d;a<u;a+=d){const p=e[a];p&&p.status!=="crossed"&&(v++,h=a)}if(v===1)return h}return-1},g=e=>{const c=e.length,o=Math.min(c,2e3);for(let n=0;n<o;n++){const s=e[n];if(!s||s.status==="crossed")continue;const t=Math.min(c,n+200);for(let r=n+1;r<t;r++){const i=e[r];if(!(!i||i.status==="crossed")&&(s.value===i.value||s.value+i.value===10)){const u=C(e,n,r);if(u!==-1)return u}}}return null},O=(e,c,o)=>{const n=e[c],s=e[o];if(!n||!s)return 0;let t=10;if(c%d===o%d&&(t+=l.SCORE.VERTICAL),n.value===s.value&&(t+=l.SCORE.SAME_VALUE),t-=c*l.SCORE.POSITION_PENALTY,m(e,c,o)){const i=Math.min(c,o),u=Math.max(c,o),v=e[i].prev,h=e[u].next;if(v!=null&&h!==null&&h!==void 0){const a=e[v],p=e[h];a&&p&&a.status!=="crossed"&&p.status!=="crossed"&&(a.value===p.value||a.value+p.value===10)&&(t+=l.SCORE.CHAIN_REACTION)}}return t},A=(e,c,o)=>{const n=[],s=e[c],t=e[o];if(!s||!t)return[];if(s.status="crossed",t.status="crossed",s.prev!==null&&s.prev!==void 0){const r=e[s.prev];r&&(n.push({index:s.prev,field:"next",oldValue:r.next}),r.next=s.next)}if(s.next!==null&&s.next!==void 0){const r=e[s.next];r&&(n.push({index:s.next,field:"prev",oldValue:r.prev}),r.prev=s.prev)}if(t.prev!==null&&t.prev!==void 0){const r=e[t.prev];r&&(n.push({index:t.prev,field:"next",oldValue:r.next}),r.next=t.next)}if(t.next!==null&&t.next!==void 0){const r=e[t.next];r&&(n.push({index:t.next,field:"prev",oldValue:r.prev}),r.prev=t.prev)}return n},R=(e,c,o,n)=>{e[c]&&(e[c].status="active"),e[o]&&(e[o].status="active");for(let s=n.length-1;s>=0;s--){const t=n[s];if(!t)continue;const r=e[t.index];r&&(r[t.field]=t.oldValue)}},S=(e,c=-1)=>{const o=[],n=e.length,s=n>4e3?l.BOT_SEARCH_LIMIT:n;for(let t=0;t<s;t++){const r=e[t];if(!r||r.status==="crossed")continue;const i=x(e,t);for(const u of i)if(u>t&&E(e,t,u)){const v=O(e,t,u);o.push({idx1:t,idx2:u,score:v})}}return o.sort((t,r)=>r.score-t.score),c>0&&o.length>c?o.slice(0,c):o},I=(e,c)=>{const o=S(e,8);if(o.length===0)return{score:0,move:null};let n=-1/0,s=null;for(const t of o){let r=t.score;if(c>0){const i=A(e,t.idx1,t.idx2),u=I(e,c-1);r+=u.score*.6,R(e,t.idx1,t.idx2,i)}r>n&&(n=r,s=[t.idx1,t.idx2])}return{score:n,move:s}};self.onmessage=e=>{const{type:c,cells:o,checkHammer:n}=e.data;if(c==="find"){const s=I(o,1);if(s.move)self.postMessage({type:"moveFound",move:s.move});else if(n){const t=g(o);self.postMessage({type:"moveFound",move:null,hammerTarget:t})}else self.postMessage({type:"moveFound",move:null})}}})();
